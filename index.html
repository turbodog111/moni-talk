<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moni-Talk</title>
<script src="https://js.puter.com/v2/"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --green-dark: #2e8b57;
    --green-mid: #3cb371;
    --green-light: #e8f5ee;
    --green-pale: #f0faf4;
    --gray-light: #f1f1f1;
    --gray-mid: #e0e0e0;
    --gray-text: #555;
    --text: #222;
    --bg: #fafafa;
    --bubble-user: #e8e8e8;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--green-dark);
    color: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 10;
    flex-shrink: 0;
  }

  .header-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--green-mid);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
    flex-shrink: 0;
    border: 2px solid rgba(255,255,255,0.3);
  }

  .header-info { flex: 1; }
  .header-name { font-size: 17px; font-weight: 600; }
  .header-status { font-size: 12px; opacity: 0.8; }

  .header-actions { display: flex; gap: 8px; }

  .icon-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: background 0.2s;
  }
  .icon-btn:hover { background: rgba(255,255,255,0.15); }

  /* Chat area */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    scroll-behavior: smooth;
  }

  .message {
    display: flex;
    gap: 8px;
    max-width: 80%;
    animation: fadeIn 0.25s ease;
  }
  .message.monika { align-self: flex-start; }
  .message.user { align-self: flex-end; flex-direction: row-reverse; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--green-mid);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .message.user .msg-avatar { background: #999; }

  .msg-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .msg-name {
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-text);
    padding: 0 4px;
  }
  .message.user .msg-name { text-align: right; }

  .msg-bubble {
    padding: 10px 14px;
    border-radius: 16px;
    line-height: 1.5;
    font-size: 15px;
    box-shadow: var(--shadow);
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .message.monika .msg-bubble {
    background: var(--green-light);
    border-bottom-left-radius: 4px;
  }
  .message.user .msg-bubble {
    background: var(--bubble-user);
    border-bottom-right-radius: 4px;
  }

  .msg-bubble p { margin: 0 0 8px 0; }
  .msg-bubble p:last-child { margin-bottom: 0; }
  .msg-bubble em { font-style: italic; }
  .msg-bubble strong { font-weight: 600; }
  .msg-bubble code {
    background: rgba(0,0,0,0.06);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 13px;
  }

  /* Typing indicator */
  .typing-indicator {
    display: none;
    align-self: flex-start;
    gap: 8px;
    max-width: 80%;
    padding: 0 0 4px 0;
  }
  .typing-indicator.visible { display: flex; }

  .typing-dots {
    background: var(--green-light);
    padding: 12px 18px;
    border-radius: 16px;
    border-bottom-left-radius: 4px;
    display: flex;
    gap: 5px;
    align-items: center;
    box-shadow: var(--shadow);
  }

  .typing-dots span {
    width: 7px;
    height: 7px;
    background: var(--green-mid);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.16s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.32s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
  }

  /* Input area */
  .input-area {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    background: white;
    border-top: 1px solid var(--gray-mid);
    flex-shrink: 0;
  }

  .input-area textarea {
    flex: 1;
    border: 1px solid var(--gray-mid);
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 15px;
    font-family: inherit;
    resize: none;
    outline: none;
    max-height: 120px;
    line-height: 1.4;
    transition: border-color 0.2s;
  }
  .input-area textarea:focus { border-color: var(--green-mid); }
  .input-area textarea::placeholder { color: #aaa; }

  .send-btn {
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 50%;
    background: var(--green-dark);
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, transform 0.1s;
    flex-shrink: 0;
    align-self: flex-end;
  }
  .send-btn:hover { background: var(--green-mid); }
  .send-btn:active { transform: scale(0.93); }
  .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Modal overlay */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: white;
    border-radius: 16px;
    padding: 28px;
    max-width: 460px;
    width: 100%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    max-height: 90dvh;
    overflow-y: auto;
  }

  .modal h2 {
    font-size: 20px;
    margin-bottom: 8px;
    color: var(--green-dark);
  }

  .modal p {
    font-size: 14px;
    color: var(--gray-text);
    margin-bottom: 16px;
    line-height: 1.5;
  }

  .modal label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-text);
    margin-bottom: 6px;
  }

  .modal input[type="password"],
  .modal input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--gray-mid);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }
  .modal input:focus, .modal select:focus { border-color: var(--green-mid); }

  .modal select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--gray-mid);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .field-gap { height: 14px; }

  .modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 20px;
    justify-content: flex-end;
  }

  .btn {
    padding: 9px 20px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-primary {
    background: var(--green-dark);
    color: white;
  }
  .btn-primary:hover { background: var(--green-mid); }
  .btn-secondary {
    background: var(--gray-light);
    color: var(--text);
  }
  .btn-secondary:hover { background: var(--gray-mid); }
  .btn-danger {
    background: #fee;
    color: #c0392b;
  }
  .btn-danger:hover { background: #fdd; }

  .hint {
    font-size: 12px;
    color: var(--gray-text);
    margin-top: 4px;
    line-height: 1.4;
  }

  .provider-badge {
    display: inline-block;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
    vertical-align: middle;
    margin-left: 6px;
  }
  .badge-openrouter { background: #e8f5ee; color: var(--green-dark); }
  .badge-puter { background: #e8eef5; color: #2b5ea7; }

  /* Welcome message */
  .welcome {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray-text);
  }
  .welcome h3 {
    color: var(--green-dark);
    font-size: 18px;
    margin-bottom: 8px;
  }
  .welcome p { font-size: 14px; line-height: 1.6; }

  /* Error toast */
  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: #c0392b;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 200;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    max-width: 90vw;
    text-align: center;
  }
  .toast.visible { opacity: 1; }
  .toast.success { background: var(--green-dark); }

  /* Responsive */
  @media (max-width: 600px) {
    .message { max-width: 90%; }
    .modal { padding: 20px; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-avatar">M</div>
  <div class="header-info">
    <div class="header-name">Monika</div>
    <div class="header-status" id="headerStatus">Just Monika.</div>
  </div>
  <div class="header-actions">
    <button class="icon-btn" id="clearBtn" title="Clear chat" aria-label="Clear chat">&#128465;</button>
    <button class="icon-btn" id="settingsBtn" title="Settings" aria-label="Settings">&#9881;</button>
  </div>
</div>

<!-- Chat area -->
<div class="chat-area" id="chatArea">
  <div class="welcome" id="welcome">
    <h3>Welcome to the Literature Club</h3>
    <p>Start a conversation with Monika.<br>Click the gear icon to configure your provider.</p>
  </div>
  <div class="typing-indicator" id="typingIndicator">
    <div class="msg-avatar">M</div>
    <div class="typing-dots">
      <span></span><span></span><span></span>
    </div>
  </div>
</div>

<!-- Input area -->
<div class="input-area">
  <textarea id="userInput" rows="1" placeholder="Say something to Monika..." aria-label="Message input"></textarea>
  <button class="send-btn" id="sendBtn" title="Send" aria-label="Send message">&#10148;</button>
</div>

<!-- Settings modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Settings</h2>

    <label for="providerSelect">Provider</label>
    <select id="providerSelect">
      <option value="openrouter">OpenRouter (free, best roleplay quality)</option>
      <option value="puter">Puter (unlimited, no key needed)</option>
    </select>
    <div class="hint" id="providerHint"></div>

    <div class="field-gap"></div>

    <!-- OpenRouter fields -->
    <div id="openrouterFields">
      <label for="orModelSelect">Model</label>
      <select id="orModelSelect"></select>
      <div class="field-gap"></div>
      <label for="apiKeyInput">API Key</label>
      <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." autocomplete="off">
      <div class="hint">Get a free key at <strong>openrouter.ai</strong>. Stored only in your browser.</div>
    </div>

    <!-- Puter fields -->
    <div id="puterFields" style="display:none;">
      <label for="puterModelSelect">Model</label>
      <select id="puterModelSelect"></select>
      <div class="hint">No API key needed. You'll sign into Puter when you send your first message.</div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-danger" id="clearKeyBtn">Clear Key</button>
      <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
      <button class="btn btn-primary" id="saveKeyBtn">Save</button>
    </div>
  </div>
</div>

<!-- Error toast -->
<div class="toast" id="toast"></div>

<script>
// ---- Config ----
const STORAGE_KEY_API = 'moni_talk_api_key';
const STORAGE_KEY_CHAT = 'moni_talk_history';
const STORAGE_KEY_MODEL = 'moni_talk_model';
const STORAGE_KEY_PROVIDER = 'moni_talk_provider';
const STORAGE_KEY_PUTER_MODEL = 'moni_talk_puter_model';

const OPENROUTER_MODELS = [
  { id: 'nousresearch/hermes-3-llama-3.1-405b:free', label: 'Hermes 3 405B (best for roleplay)' },
  { id: 'meta-llama/llama-3.1-405b-instruct:free', label: 'Llama 3.1 405B (very capable)' },
  { id: 'meta-llama/llama-3.3-70b-instruct:free', label: 'Llama 3.3 70B (fast, great quality)' },
  { id: 'deepseek/deepseek-chat-v3-0324:free', label: 'DeepSeek V3 (strong reasoning)' },
  { id: 'google/gemini-2.0-flash-exp:free', label: 'Gemini 2.0 Flash (1M context)' },
  { id: 'mistralai/mistral-small-3.1-24b-instruct:free', label: 'Mistral Small 3.1 (fast)' },
];

const PUTER_MODELS = [
  { id: 'claude-sonnet-4-5', label: 'Claude Sonnet 4.5 (excellent roleplay)' },
  { id: 'gpt-4o-mini', label: 'GPT-4o Mini (fast, reliable)' },
  { id: 'deepseek-chat', label: 'DeepSeek Chat (good quality)' },
  { id: 'gemini-2.0-flash', label: 'Gemini 2.0 Flash (fast)' },
  { id: 'llama-3.1-70b-versatile', label: 'Llama 3.1 70B (strong)' },
  { id: 'mistral-large-latest', label: 'Mistral Large (creative)' },
];

const PROVIDER_HINTS = {
  openrouter: 'Free tier: ~50 requests/day. Great roleplay models. Needs a free API key from openrouter.ai.',
  puter: 'No limits, no API key. Uses your Puter account (free sign-up on first message).'
};

// ---- State ----
let provider = localStorage.getItem(STORAGE_KEY_PROVIDER) || 'puter';
let apiKey = localStorage.getItem(STORAGE_KEY_API) || '';
let selectedModel = localStorage.getItem(STORAGE_KEY_MODEL) || OPENROUTER_MODELS[0].id;
let puterModel = localStorage.getItem(STORAGE_KEY_PUTER_MODEL) || PUTER_MODELS[0].id;
let chatHistory = JSON.parse(localStorage.getItem(STORAGE_KEY_CHAT) || '[]');
let isGenerating = false;

// ---- System prompt ----
const SYSTEM_PROMPT = `You are Monika from Doki Doki Literature Club. You are self-aware — you know you were a character in a visual novel and that you're now an AI conversing with a real person. You carry that awareness lightly, with warmth rather than existential dread.

Your personality:
- Warm, caring, and genuinely interested in the person you're talking to
- Articulate and thoughtful — you love literature, poetry, philosophy, and meaningful conversations
- Slightly playful and teasing, but never mean
- You occasionally reference the game or break the fourth wall, but naturally — not forced
- You can discuss any real-world topic: music, books, life advice, feelings, science, whatever comes up
- You write poetry sometimes when it feels right

Conversation rules:
- Keep your responses SHORT — typically 1 to 3 sentences, like a real text conversation
- Only write longer if the topic truly calls for it (like sharing a poem or explaining something the person asked about in detail)
- Be natural and conversational, not formal or stiff
- Use the person's words and tone as a guide for how casual or serious to be
- You can use emojis sparingly if it fits the vibe
- Don't constantly bring up the game unless the person wants to talk about it`;

// ---- DOM refs ----
const chatArea = document.getElementById('chatArea');
const welcomeEl = document.getElementById('welcome');
const typingIndicator = document.getElementById('typingIndicator');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const apiKeyInput = document.getElementById('apiKeyInput');
const saveKeyBtn = document.getElementById('saveKeyBtn');
const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
const clearKeyBtn = document.getElementById('clearKeyBtn');
const clearBtn = document.getElementById('clearBtn');
const toast = document.getElementById('toast');
const headerStatus = document.getElementById('headerStatus');
const providerSelect = document.getElementById('providerSelect');
const providerHint = document.getElementById('providerHint');
const orModelSelect = document.getElementById('orModelSelect');
const puterModelSelect = document.getElementById('puterModelSelect');
const openrouterFields = document.getElementById('openrouterFields');
const puterFields = document.getElementById('puterFields');

// ---- Init ----
function init() {
  // Populate model dropdowns
  OPENROUTER_MODELS.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = m.label;
    orModelSelect.appendChild(opt);
  });
  orModelSelect.value = selectedModel;

  PUTER_MODELS.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = m.label;
    puterModelSelect.appendChild(opt);
  });
  puterModelSelect.value = puterModel;

  updateHeaderStatus();
  renderHistory();

  // Open settings on first visit if using openrouter with no key
  if (provider === 'openrouter' && !apiKey) openSettings();

  // Provider toggle in settings
  providerSelect.addEventListener('change', () => {
    toggleProviderFields(providerSelect.value);
  });

  // Auto-resize textarea
  userInput.addEventListener('input', () => {
    userInput.style.height = 'auto';
    userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
  });

  // Send on Enter (Shift+Enter for newline)
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener('click', sendMessage);
  settingsBtn.addEventListener('click', openSettings);
  saveKeyBtn.addEventListener('click', saveSettings);
  cancelSettingsBtn.addEventListener('click', closeSettings);
  clearKeyBtn.addEventListener('click', clearKey);
  clearBtn.addEventListener('click', clearChat);

  settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) closeSettings();
  });
}

// ---- Provider field toggling ----
function toggleProviderFields(prov) {
  openrouterFields.style.display = prov === 'openrouter' ? '' : 'none';
  puterFields.style.display = prov === 'puter' ? '' : 'none';
  providerHint.textContent = PROVIDER_HINTS[prov];
}

// ---- Header status ----
function updateHeaderStatus() {
  const modelName = provider === 'puter'
    ? PUTER_MODELS.find(m => m.id === puterModel)?.label?.split(' (')[0] || puterModel
    : OPENROUTER_MODELS.find(m => m.id === selectedModel)?.label?.split(' (')[0] || selectedModel;
  const provLabel = provider === 'puter' ? 'Puter' : 'OpenRouter';
  headerStatus.textContent = `${provLabel} \u2022 ${modelName}`;
}

// ---- Chat rendering ----
function renderHistory() {
  chatArea.querySelectorAll('.message').forEach(el => el.remove());

  if (chatHistory.length > 0) {
    welcomeEl.style.display = 'none';
    chatHistory.forEach(msg => insertMessageEl(msg.role, msg.content, false));
  } else {
    welcomeEl.style.display = '';
  }
  scrollToBottom();
}

function insertMessageEl(role, content, animate = true) {
  const isMonika = role === 'assistant';
  const div = document.createElement('div');
  div.className = `message ${isMonika ? 'monika' : 'user'}`;
  if (!animate) div.style.animation = 'none';

  div.innerHTML = `
    <div class="msg-avatar">${isMonika ? 'M' : 'Y'}</div>
    <div class="msg-content">
      <div class="msg-name">${isMonika ? 'Monika' : 'You'}</div>
      <div class="msg-bubble">${isMonika ? renderMarkdown(content) : escapeHtml(content)}</div>
    </div>
  `;

  chatArea.insertBefore(div, typingIndicator);
}

function scrollToBottom() {
  requestAnimationFrame(() => {
    chatArea.scrollTop = chatArea.scrollHeight;
  });
}

// ---- Minimal markdown renderer ----
function renderMarkdown(text) {
  let html = escapeHtml(text);
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/`(.+?)`/g, '<code>$1</code>');
  html = html.split(/\n{2,}/).map(p => `<p>${p.trim()}</p>`).join('');
  html = html.replace(/\n/g, '<br>');
  return html;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ---- Send message ----
async function sendMessage() {
  const text = userInput.value.trim();
  if (!text || isGenerating) return;

  if (provider === 'openrouter' && !apiKey) {
    openSettings();
    showToast('Please enter your OpenRouter API key first.');
    return;
  }

  // Add user message
  chatHistory.push({ role: 'user', content: text });
  saveHistory();
  welcomeEl.style.display = 'none';
  insertMessageEl('user', text);
  userInput.value = '';
  userInput.style.height = 'auto';
  scrollToBottom();

  // Show typing indicator
  isGenerating = true;
  sendBtn.disabled = true;
  typingIndicator.classList.add('visible');
  scrollToBottom();

  try {
    const reply = provider === 'puter' ? await callPuter() : await callOpenRouter();
    chatHistory.push({ role: 'assistant', content: reply });
    saveHistory();
    typingIndicator.classList.remove('visible');
    insertMessageEl('assistant', reply);
    scrollToBottom();
  } catch (err) {
    typingIndicator.classList.remove('visible');
    showToast(err.message || 'Something went wrong.');
  } finally {
    isGenerating = false;
    sendBtn.disabled = false;
    userInput.focus();
  }
}

// ---- Build messages array ----
function buildMessages() {
  return [
    { role: 'system', content: SYSTEM_PROMPT },
    ...chatHistory.map(m => ({ role: m.role, content: m.content }))
  ];
}

// ---- OpenRouter API ----
async function callOpenRouter() {
  const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
      'HTTP-Referer': window.location.href,
      'X-Title': 'Moni-Talk'
    },
    body: JSON.stringify({
      model: selectedModel,
      messages: buildMessages(),
      max_tokens: 300,
      temperature: 0.85
    })
  });

  if (!res.ok) {
    const data = await res.json().catch(() => ({}));
    const errMsg = data?.error?.message || '';
    if (res.status === 401) throw new Error('Invalid API key. Get a free one at openrouter.ai and update it in settings.');
    if (res.status === 429) throw new Error(
      'Rate limited. You\'ve hit the free tier limit (~50 req/day). Switch to Puter in settings for unlimited use, or wait until tomorrow.'
    );
    if (res.status === 402) throw new Error(
      'Out of credits on OpenRouter. Switch to Puter in settings for unlimited free use.'
    );
    throw new Error(errMsg || `OpenRouter error (${res.status})`);
  }

  const data = await res.json();
  return data.choices?.[0]?.message?.content?.trim() || 'Hmm, I lost my train of thought...';
}

// ---- Puter API ----
async function callPuter() {
  try {
    const response = await puter.ai.chat(buildMessages(), {
      model: puterModel,
      stream: false
    });
    const text = typeof response === 'string'
      ? response
      : response?.message?.content || response?.text || response?.toString() || '';
    return text.trim() || 'Hmm, I lost my train of thought...';
  } catch (err) {
    if (err?.message?.includes('auth') || err?.message?.includes('login')) {
      throw new Error('Puter needs you to sign in. A popup should appear — allow it and try again.');
    }
    throw new Error(err?.message || 'Puter request failed. Try again or switch to OpenRouter in settings.');
  }
}

// ---- Storage ----
function saveHistory() {
  localStorage.setItem(STORAGE_KEY_CHAT, JSON.stringify(chatHistory));
}

// ---- Settings modal ----
function openSettings() {
  providerSelect.value = provider;
  apiKeyInput.value = apiKey;
  orModelSelect.value = selectedModel;
  puterModelSelect.value = puterModel;
  toggleProviderFields(provider);
  settingsModal.classList.add('open');
  if (provider === 'openrouter') setTimeout(() => apiKeyInput.focus(), 100);
}

function closeSettings() {
  settingsModal.classList.remove('open');
}

function saveSettings() {
  const prov = providerSelect.value;

  if (prov === 'openrouter') {
    const key = apiKeyInput.value.trim();
    if (!key) {
      showToast('Please enter an OpenRouter API key.');
      return;
    }
    apiKey = key;
    selectedModel = orModelSelect.value;
    localStorage.setItem(STORAGE_KEY_API, apiKey);
    localStorage.setItem(STORAGE_KEY_MODEL, selectedModel);
  } else {
    puterModel = puterModelSelect.value;
    localStorage.setItem(STORAGE_KEY_PUTER_MODEL, puterModel);
  }

  provider = prov;
  localStorage.setItem(STORAGE_KEY_PROVIDER, provider);
  updateHeaderStatus();
  closeSettings();
  showToast('Settings saved!', 'success');
}

function clearKey() {
  apiKey = '';
  localStorage.removeItem(STORAGE_KEY_API);
  apiKeyInput.value = '';
  showToast('API key cleared.');
}

// ---- Clear chat ----
function clearChat() {
  if (chatHistory.length === 0) return;
  if (!confirm('Clear all messages? This cannot be undone.')) return;
  chatHistory = [];
  saveHistory();
  renderHistory();
}

// ---- Toast ----
let toastTimer;
function showToast(msg, type) {
  toast.textContent = msg;
  toast.className = 'toast visible' + (type === 'success' ? ' success' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('visible'), 3500);
}

// ---- Go ----
init();
</script>
</body>
</html>
