<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Moni-Talk</title>
<script src="https://js.puter.com/v2/"></script>
<script>
  // Apply theme immediately to prevent flash
  (function(){
    var t = localStorage.getItem('moni_talk_theme') || 'system';
    var e = t === 'system' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : t;
    document.documentElement.dataset.theme = e;
  })();
</script>
<link rel="stylesheet" href="css/base.css">
<link rel="stylesheet" href="css/chat.css">
<link rel="stylesheet" href="css/vn.css">
<link rel="stylesheet" href="css/room.css">
</head>
<body>

<!-- SCREEN: Chat List -->
<div class="screen active" id="screenChatList">
  <div class="header">
    <img class="header-avatar" src="Monika PFP.png" alt="Monika">
    <div class="header-info">
      <div class="header-name">Moni-Talk</div>
      <div class="header-sub" id="chatListSub">Your conversations with Monika</div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="themeToggleBtn" title="Toggle Theme" aria-label="Toggle Theme"><span class="theme-toggle-icon">&#9790;</span></button>
      <button class="icon-btn sync-btn" id="syncBtn" title="Cloud Sync" aria-label="Cloud Sync">&#9729;<span class="sync-dot offline" id="syncDot"></span></button>
      <button class="icon-btn" id="profileBtn" title="Your Profile" aria-label="Profile">&#128100;</button>
      <button class="icon-btn" id="globalSettingsBtn" title="Settings" aria-label="Settings">&#9881;</button>
    </div>
  </div>
  <div class="chat-list-body" id="chatListBody"></div>
  <button class="fab" id="newChatFab" title="New Chat">+</button>
</div>

<!-- SCREEN: Profile Setup -->
<div class="screen" id="screenProfile">
  <div class="header">
    <button class="icon-btn" id="profileBackBtn" aria-label="Back">&#8592;</button>
    <div class="header-info">
      <div class="header-name">Your Profile</div>
      <div class="header-sub">Help Monika get to know you</div>
    </div>
  </div>
  <div class="form-body">
    <img src="Monika PFP.png" alt="Monika">
    <h2>About You</h2>
    <div class="subtitle">Monika will remember these details across all chats.</div>
    <div class="form-section">
      <label for="profileName">Your Name</label>
      <input type="text" id="profileName" placeholder="What should Monika call you?">
    </div>
    <div class="form-section">
      <label for="profileAbout">About You</label>
      <textarea id="profileAbout" rows="3" placeholder="Tell Monika a bit about yourself... age, what you do, personality, etc."></textarea>
    </div>
    <div class="form-section">
      <label for="profileInterests">Interests & Hobbies</label>
      <textarea id="profileInterests" rows="2" placeholder="Gaming, music, reading, cooking, coding..."></textarea>
    </div>
    <div class="form-section">
      <label for="profileValues">What You Value</label>
      <textarea id="profileValues" rows="2" placeholder="Honesty, humor, deep conversations, loyalty..."></textarea>
    </div>
    <button class="primary-btn" id="saveProfileBtn">Save Profile</button>
  </div>
</div>

<!-- SCREEN: New Chat -->
<div class="screen" id="screenNewChat">
  <div class="header">
    <button class="icon-btn" id="newChatBackBtn" aria-label="Back">&#8592;</button>
    <div class="header-info">
      <div class="header-name">New Conversation</div>
      <div class="header-sub">Choose your relationship with Monika</div>
    </div>
  </div>
  <div class="form-body">
    <img src="Monika PFP.png" alt="Monika">
    <h2 id="newChatTitle">Talk to Monika</h2>
    <div class="subtitle" id="newChatSubtitle">How well do you two know each other?</div>
    <div class="mode-toggle">
      <button id="modeChatBtn" class="active">Chat</button>
      <button id="modeStoryBtn">Story</button>
      <button id="modeRoomBtn">Room</button>
    </div>
    <div id="chatModeOptions" class="form-section">
      <div class="rel-display">
        <div class="rel-label" id="relLabel"></div>
        <div class="rel-desc" id="relDesc"></div>
      </div>
      <input type="range" id="relSlider" min="0" max="5" value="2" step="1">
      <div class="slider-labels"><span>Stranger</span><span>In Love</span></div>
    </div>
    <div id="storyModeOptions" class="form-section" style="display:none;">
      <div class="rel-display">
        <div class="rel-label">Interactive Story</div>
        <div class="rel-desc">Experience DDLC as an interactive visual novel. Make choices that shape your story &mdash; and this time, every girl has a route. Even Monika.</div>
      </div>
      <div class="form-section" style="margin-top:16px;">
        <label for="mcNameInput">Your Character's Name</label>
        <input type="text" id="mcNameInput" placeholder="What should the MC be called?">
        <div class="form-hint">This name will be used throughout the story.</div>
      </div>
    </div>
    <div id="roomModeOptions" class="form-section" style="display:none;">
      <div class="rel-display">
        <div class="rel-label">Monika's Room</div>
        <div class="rel-desc">Sit across from Monika in the space classroom &mdash; just the two of you. Chat freely while she reacts with full MAS-style expressions.</div>
      </div>
      <div class="form-section" style="margin-top:16px;">
        <div class="rel-display">
          <div class="rel-label" id="roomRelLabel"></div>
          <div class="rel-desc" id="roomRelDesc"></div>
        </div>
        <input type="range" id="roomRelSlider" min="0" max="5" value="2" step="1">
        <div class="slider-labels"><span>Stranger</span><span>In Love</span></div>
      </div>
    </div>
    <button class="primary-btn" id="startChatBtn">Start Chatting</button>
  </div>
</div>

<!-- SCREEN: Chat -->
<div class="screen" id="screenChat">
  <div class="header">
    <button class="icon-btn" id="chatBackBtn" aria-label="Back">&#8592;</button>
    <img class="header-avatar" src="Monika PFP.png" alt="Monika">
    <div class="header-info">
      <div class="header-name" id="chatHeaderName">Monika</div>
      <div class="header-sub" id="chatHeaderSub">Just Monika.</div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="vnPanelBtn" title="Status Panel" style="display:none;">&#9776;</button>
      <button class="icon-btn" id="chatSettingsBtn" title="Settings">&#9881;</button>
    </div>
  </div>
  <div class="affinity-panel" id="affinityPanel">
    <div class="affinity-rows">
      <div class="affinity-row"><span class="affinity-name">Sayori</span><div class="affinity-track"><div class="affinity-fill sayori" id="affinitySayori" style="width:30%"></div></div></div>
      <div class="affinity-row"><span class="affinity-name">Natsuki</span><div class="affinity-track"><div class="affinity-fill natsuki" id="affinityNatsuki" style="width:30%"></div></div></div>
      <div class="affinity-row"><span class="affinity-name">Yuri</span><div class="affinity-track"><div class="affinity-fill yuri" id="affinityYuri" style="width:30%"></div></div></div>
      <div class="affinity-row"><span class="affinity-name">Monika</span><div class="affinity-track"><div class="affinity-fill monika" id="affinityMonika" style="width:30%"></div></div></div>
    </div>
  </div>
  <div class="vn-sprites" id="vnSprites">
    <div class="vn-sprite sayori" id="spriteSayori"><img src="Sayori PFP.png" alt="Sayori"><span class="vn-sprite-name">Sayori</span></div>
    <div class="vn-sprite natsuki" id="spriteNatsuki"><img src="Natsuki PFP.png" alt="Natsuki"><span class="vn-sprite-name">Natsuki</span></div>
    <div class="vn-sprite yuri" id="spriteYuri"><img src="Yuri PFP.png" alt="Yuri"><span class="vn-sprite-name">Yuri</span></div>
    <div class="vn-sprite monika" id="spriteMonika"><img src="Monika PFP.png" alt="Monika"><span class="vn-sprite-name">Monika</span></div>
    <div class="vn-route-indicator" id="routeIndicator" style="display:none;"></div>
  </div>
  <div class="room-scene" id="roomScene" style="display:none;">
    <canvas id="masCanvas" width="1280" height="850"></canvas>
  </div>
  <div class="chat-area" id="chatArea">
    <div class="typing-indicator" id="typingIndicator">
      <img class="msg-avatar" src="Monika PFP.png" alt="M">
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>
  </div>
  <div class="context-bar" id="contextBar">
    <span id="contextLabel">0 messages</span>
    <div class="context-bar-fill"><div class="context-bar-used" id="contextFill"></div></div>
    <button id="trimBtn" title="Remove older messages to free up context">Trim</button>
    <button id="storyRetryBtn" class="story-retry-btn" title="Force continue if the story is stuck" style="display:none;">Stuck?</button>
  </div>
  <div class="image-preview" id="imagePreview" style="display:none;"></div>
  <div class="input-area" id="inputArea">
    <button class="image-attach-btn" id="imageAttachBtn" title="Attach image">&#128206;</button>
    <input type="file" id="imageFileInput" accept="image/*" style="display:none;">
    <textarea id="userInput" rows="1" placeholder="Say something to Monika..."></textarea>
    <button class="send-btn" id="sendBtn" title="Send">&#10148;</button>
  </div>
  <div class="story-choices" id="storyChoices" style="display:none;"></div>
  <div class="word-picker" id="wordPicker" style="display:none;">
    <div class="word-picker-title">Write Your Poem</div>
    <div class="word-picker-hint">Pick 5 words that inspire you. <span id="wordCount">0/5</span></div>
    <div class="word-grid" id="wordGrid"></div>
    <button class="word-submit-btn" id="wordSubmitBtn" disabled>Share Poem</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Settings</h2>
    <label for="providerSelect">Provider</label>
    <select id="providerSelect">
      <option value="gemini">Gemini (Google AI, free tier)</option>
      <option value="ollama">Ollama (local, free, unlimited)</option>
      <option value="openrouter">OpenRouter (free, best roleplay quality)</option>
      <option value="puter">Puter (unlimited, no key needed)</option>
    </select>
    <div class="hint" id="providerHint"></div>
    <div class="field-gap"></div>
    <div id="openrouterFields">
      <label for="orModelSelect">Model</label>
      <select id="orModelSelect"></select>
      <div class="field-gap"></div>
      <label for="apiKeyInput">API Key</label>
      <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." autocomplete="off">
      <div class="hint">Get a free key at <strong>openrouter.ai</strong>.</div>
    </div>
    <div id="puterFields" style="display:none;">
      <label for="puterModelSelect">Model</label>
      <select id="puterModelSelect"></select>
      <div class="hint">No API key needed. You'll sign into Puter on first message.</div>
    </div>
    <div id="geminiFields" style="display:none;">
      <label for="geminiModelSelect">Model</label>
      <select id="geminiModelSelect"></select>
      <div class="field-gap"></div>
      <label for="geminiKeyInput">API Key</label>
      <input type="password" id="geminiKeyInput" placeholder="AIzaSy..." autocomplete="off">
      <div class="hint">Get a free key at <strong>aistudio.google.com</strong>. Free tier: 15 req/min.</div>
    </div>
    <div id="ollamaFields" style="display:none;">
      <label for="ollamaModelSelect">Model</label>
      <select id="ollamaModelSelect"></select>
      <div class="hint">Models you've pulled with <strong>ollama pull</strong> appear here automatically.</div>
      <div class="field-gap"></div>
      <label for="ollamaEndpointInput">Endpoint</label>
      <input type="text" id="ollamaEndpointInput" placeholder="http://localhost:11434" autocomplete="off">
      <div class="hint">Default: http://localhost:11434. Change only if you moved the port.</div>
    </div>
    <div class="field-gap"></div>
    <label for="themeSelect">Theme</label>
    <select id="themeSelect">
      <option value="system">System (auto)</option>
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
    <div class="hint">Choose your preferred color theme.</div>
    <div class="field-gap"></div>
    <label>Model Benchmark</label>
    <div class="hint">Run standardized tests to compare how well your current model handles Moni-Talk scenarios (character voice, tag formatting, affinity tracking).</div>
    <button class="btn btn-primary bench-open-btn" id="openBenchmarkBtn" style="width:100%;margin-top:8px;">Open Benchmark Suite</button>
    <div id="benchSettingsHint"></div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="clearKeyBtn">Clear Key</button>
      <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
      <button class="btn btn-primary" id="saveKeyBtn">Save</button>
    </div>
  </div>
</div>

<!-- Sync Modal -->
<div class="modal-overlay" id="syncModal">
  <div class="modal">
    <h2>&#9729; Cloud Sync</h2>
    <div id="syncSignedOut">
      <p>Sign in with a free Puter account to sync your chats and profile across all your devices. No setup needed.</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelSyncBtn">Cancel</button>
        <button class="btn btn-primary" id="signInBtn">Sign In to Puter</button>
      </div>
    </div>
    <div id="syncSignedIn" style="display:none">
      <div class="sync-info">
        <div class="sync-user" id="syncUsername"></div>
        <div class="sync-state" id="syncStateText">Checking...</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
        <button class="btn btn-secondary" id="closeSyncBtn">Close</button>
        <button class="btn btn-primary" id="syncNowBtn">Sync Now</button>
      </div>
    </div>
  </div>
</div>

<!-- Benchmark Modal -->
<div class="modal-overlay" id="benchmarkModal">
  <div class="modal bench-modal">
    <div class="bench-header">
      <h2>Benchmark Suite</h2>
      <button class="bench-close" id="benchCloseBtn">&times;</button>
    </div>
    <div class="bench-model-bar" id="benchModelInfo"></div>
    <div class="bench-tabs">
      <button class="bench-tab active" id="benchTabRun">Run Tests</button>
      <button class="bench-tab" id="benchTabResults">Results</button>
    </div>
    <div class="bench-body" id="benchRunContent">
      <div id="benchModelViewer"></div>
      <div class="bench-section">
        <h3>Story Mode</h3>
        <div id="benchStoryTests"></div>
      </div>
      <div class="bench-section">
        <h3>Casual Chat</h3>
        <div id="benchChatTests"></div>
      </div>
      <div class="bench-actions">
        <button class="btn btn-primary" id="benchRunAllBtn">Run All Tests</button>
        <button class="btn btn-secondary" id="benchRunStoryBtn">Story Only</button>
        <button class="btn btn-secondary" id="benchRunChatBtn">Chat Only</button>
      </div>
      <div class="bench-progress" id="benchProgressSection" style="display:none;">
        <div class="bench-progress-row">
          <span id="benchProgressLabel">Preparing...</span>
          <button class="btn btn-danger btn-sm" id="benchCancelBtn">Cancel</button>
        </div>
        <div class="bench-progress-track"><div class="bench-progress-fill" id="benchProgressBar" style="width:0%"></div></div>
      </div>
    </div>
    <div class="bench-body" id="benchResultsContent" style="display:none;"></div>
  </div>
</div>

<!-- VN Side Panel -->
<div class="vn-panel-backdrop" id="vnPanelBackdrop"></div>
<div class="vn-side-panel" id="vnSidePanel">
  <div class="vn-panel-header">
    <h3>Literature Club</h3>
    <button class="vn-panel-close" id="vnPanelClose">&times;</button>
  </div>
  <div class="vn-panel-body">
    <div class="vn-panel-section">
      <div class="vn-day-display">
        <div class="vn-day-number" id="vnDayNumber">1</div>
        <div class="vn-day-label">School Day</div>
        <div class="vn-scene-label" id="vnSceneLabel"></div>
      </div>
    </div>
    <div class="vn-panel-section">
      <h4>Relationships</h4>
      <div class="vn-affinity-row">
        <img class="vn-affinity-portrait" src="Sayori PFP.png" alt="Sayori">
        <div class="vn-affinity-info">
          <div class="vn-affinity-name-row"><span class="vn-affinity-label">Sayori</span><span class="vn-affinity-val" id="vnAffinitySayoriVal">15</span></div>
          <div class="vn-affinity-track"><div class="vn-affinity-fill sayori" id="vnAffinitySayori" style="width:15%"></div><div class="vn-affinity-ticks" id="vnTicksSayori"></div></div>
        </div>
      </div>
      <div class="vn-affinity-row">
        <img class="vn-affinity-portrait" src="Monika PFP.png" alt="Monika">
        <div class="vn-affinity-info">
          <div class="vn-affinity-name-row"><span class="vn-affinity-label">Monika</span><span class="vn-affinity-val" id="vnAffinityMonikaVal">10</span></div>
          <div class="vn-affinity-track"><div class="vn-affinity-fill monika" id="vnAffinityMonika" style="width:10%"></div><div class="vn-affinity-ticks" id="vnTicksMonika"></div></div>
        </div>
      </div>
      <div class="vn-affinity-row">
        <img class="vn-affinity-portrait" src="Natsuki PFP.png" alt="Natsuki">
        <div class="vn-affinity-info">
          <div class="vn-affinity-name-row"><span class="vn-affinity-label">Natsuki</span><span class="vn-affinity-val" id="vnAffinityNatsukiVal">1</span></div>
          <div class="vn-affinity-track"><div class="vn-affinity-fill natsuki" id="vnAffinityNatsuki" style="width:1%"></div><div class="vn-affinity-ticks" id="vnTicksNatsuki"></div></div>
        </div>
      </div>
      <div class="vn-affinity-row">
        <img class="vn-affinity-portrait" src="Yuri PFP.png" alt="Yuri">
        <div class="vn-affinity-info">
          <div class="vn-affinity-name-row"><span class="vn-affinity-label">Yuri</span><span class="vn-affinity-val" id="vnAffinityYuriVal">1</span></div>
          <div class="vn-affinity-track"><div class="vn-affinity-fill yuri" id="vnAffinityYuri" style="width:1%"></div><div class="vn-affinity-ticks" id="vnTicksYuri"></div></div>
        </div>
      </div>
    </div>
    <div class="vn-panel-section" id="dynamicsSection" style="display:none;">
      <h4>Dynamics</h4>
      <div class="vn-dynamics-list" id="vnDynamicsList"></div>
    </div>
    <div class="vn-panel-section">
      <h4>Guide</h4>
      <div class="vn-scene-info">
        <strong>25</strong> &mdash; Friendly<br>
        <strong>50</strong> &mdash; Close / Romantic Interest<br>
        <strong>75</strong> &mdash; Deep Love<br>
        <strong>100</strong> &mdash; Soulmate
      </div>
    </div>
    <div class="vn-panel-section">
      <h4>Checkpoints</h4>
      <button class="cp-save-btn" id="cpSaveBtn">Save Checkpoint</button>
      <div class="cp-list" id="checkpointList">
        <div class="cp-empty">No checkpoints yet</div>
      </div>
    </div>
  </div>
</div>

<!-- Journal Overlay -->
<div class="journal-overlay" id="journalOverlay">
  <div class="journal-container">
    <div class="journal-header">
      <h2>End of Day <span id="journalDayNum">1</span></h2>
      <p>What the girls wrote in their diaries tonight...</p>
    </div>
    <div class="journal-entries" id="journalEntries"></div>
    <button class="journal-continue-btn" id="journalContinueBtn">Begin Next Day</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- JS (order matters — dependencies flow top to bottom) -->
<script src="js/config.js"></script>
<script src="js/state.js"></script>
<script src="js/profile.js"></script>
<script src="js/ai.js"></script>
<script src="js/settings.js"></script>
<script src="js/sync.js"></script>
<script src="js/memory.js"></script>
<script src="js/benchmark.js"></script>
<script src="js/chat.js"></script>
<script src="js/story.js"></script>
<script src="js/vn.js"></script>
<script src="js/room.js"></script>
<script src="js/app.js"></script>
</body>
</html>
